<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SingleClick – Gestión de Grupos</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Iconos -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <style>
    /* Mini toasts */
    .toast { animation: fade 3.5s ease forwards; }
    @keyframes fade { 0%{opacity:0;transform:translateY(-6px)}
      10%{opacity:1;transform:translateY(0)}
      90%{opacity:1}
      100%{opacity:0;transform:translateY(-6px)} }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Header -->
  <header class="bg-white border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-5 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl bg-slate-900 text-white grid place-items-center font-bold">SC</div>
        <div>
          <h1 class="text-xl font-semibold">SingleClick – Gestión de Grupos</h1>
          <p class="text-sm text-slate-500">Demo para reclutadores • FastAPI + Frontend limpio</p>
        </div>
      </div>
      <a href="/docs" class="text-sm text-slate-500 hover:text-slate-700 underline">Ver API (/docs)</a>
    </div>
  </header>

  <!-- Contenido -->
  <main class="max-w-6xl mx-auto px-4 py-8 space-y-8">
    <!-- Resumen -->
    <section>
      <h2 class="text-lg font-medium mb-3">Resumen</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="cards-resumen">
        <div class="rounded-2xl border bg-white p-5">
          <p class="text-sm text-slate-500">Proyectos</p>
          <p class="text-3xl font-semibold" id="card-proyectos">—</p>
        </div>
        <div class="rounded-2xl border bg-white p-5">
          <p class="text-sm text-slate-500">En progreso</p>
          <p class="text-3xl font-semibold" id="card-en-progreso">—</p>
        </div>
        <div class="rounded-2xl border bg-white p-5">
          <p class="text-sm text-slate-500">Finalizados</p>
          <p class="text-3xl font-semibold" id="card-done">—</p>
        </div>
        <div class="rounded-2xl border bg-white p-5">
          <p class="text-sm text-slate-500">Miembros</p>
          <p class="text-3xl font-semibold" id="card-miembros">—</p>
        </div>
      </div>
    </section>

    <!-- Tabs -->
    <section class="space-y-4">
      <div class="flex items-center gap-2">
        <button id="tab-miembros" class="px-4 py-2 rounded-xl bg-slate-900 text-white">Miembros</button>
        <button id="tab-proyectos" class="px-4 py-2 rounded-xl hover:bg-slate-200">Proyectos</button>
      </div>

      <!-- Paneles -->
      <div id="panel-miembros" class="space-y-6">
        <!-- Crear miembro -->
        <div class="rounded-2xl border bg-white p-5">
          <h3 class="font-semibold mb-3">Crear miembro</h3>
          <form id="form-miembro" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <input class="border rounded-xl px-3 py-2" type="text" name="nombre" placeholder="Nombre" required minlength="2" />
            <input class="border rounded-xl px-3 py-2" type="text" name="rol" placeholder="Rol (opcional)" />
            <input class="border rounded-xl px-3 py-2" type="email" name="email" placeholder="Email" required />
            <button class="rounded-xl bg-slate-900 text-white px-4 py-2">Guardar</button>
          </form>
          <p id="msg-miembro" class="text-sm text-red-600 mt-2 hidden"></p>
        </div>

        <!-- Lista miembros -->
        <div class="rounded-2xl border bg-white p-5">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">Miembros</h3>
            <button id="btn-refrescar-miembros" class="text-sm px-3 py-1.5 rounded-lg border hover:bg-slate-100">Refrescar</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-left border-b">
                  <th class="py-2 pr-3">ID</th>
                  <th class="py-2 pr-3">Nombre</th>
                  <th class="py-2 pr-3">Rol</th>
                  <th class="py-2 pr-3">Email</th>
                </tr>
              </thead>
              <tbody id="tbody-miembros"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="panel-proyectos" class="space-y-6 hidden">
        <!-- Crear proyecto -->
        <div class="rounded-2xl border bg-white p-5">
          <h3 class="font-semibold mb-3">Crear proyecto</h3>
          <form id="form-proyecto" class="grid grid-cols-1 md:grid-cols-6 gap-4">
            <input class="border rounded-xl px-3 py-2 md:col-span-2" type="text" name="nombre" placeholder="Nombre" required minlength="2" />
            <input class="border rounded-xl px-3 py-2 md:col-span-2" type="text" name="descripcion" placeholder="Descripción (opcional)" />
            <select class="border rounded-xl px-3 py-2" name="estado">
              <option value="EN_PROGRESO">EN_PROGRESO</option>
              <option value="DONE">DONE</option>
            </select>
            <input class="border rounded-xl px-3 py-2" type="date" name="start_date" />
            <input class="border rounded-xl px-3 py-2" type="date" name="end_date" />
            <button class="rounded-xl bg-slate-900 text-white px-4 py-2 md:col-span-1">Guardar</button>
          </form>
          <p id="msg-proyecto" class="text-sm text-red-600 mt-2 hidden"></p>
        </div>

        <!-- Lista proyectos -->
        <div class="rounded-2xl border bg-white p-5">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">Proyectos</h3>
            <button id="btn-refrescar-proyectos" class="text-sm px-3 py-1.5 rounded-lg border hover:bg-slate-100">Refrescar</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-left border-b">
                  <th class="py-2 pr-3">ID</th>
                  <th class="py-2 pr-3">Nombre</th>
                  <th class="py-2 pr-3">Estado</th>
                  <th class="py-2 pr-3">Inicio</th>
                  <th class="py-2 pr-3">Fin</th>
                </tr>
              </thead>
              <tbody id="tbody-proyectos"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Toaster -->
  <div id="toasts" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <script>
    // ------------------ Helpers UI ------------------
    const $ = (sel) => document.querySelector(sel);
    const showToast = (msg, ok=true) => {
      const wrap = document.createElement('div');
      wrap.className = `toast px-4 py-3 rounded-xl shadow border ${ok ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'}`;
      wrap.textContent = msg;
      $('#toasts').appendChild(wrap);
      setTimeout(() => wrap.remove(), 3600);
    };
    const fmt = (d)=> d ? new Date(d).toISOString().slice(0,10) : '';

    // ------------------ Tabs ------------------
    $('#tab-miembros').addEventListener('click', () => {
      $('#tab-miembros').className = 'px-4 py-2 rounded-xl bg-slate-900 text-white';
      $('#tab-proyectos').className = 'px-4 py-2 rounded-xl hover:bg-slate-200';
      $('#panel-miembros').classList.remove('hidden');
      $('#panel-proyectos').classList.add('hidden');
    });
    $('#tab-proyectos').addEventListener('click', () => {
      $('#tab-proyectos').className = 'px-4 py-2 rounded-xl bg-slate-900 text-white';
      $('#tab-miembros').className = 'px-4 py-2 rounded-xl hover:bg-slate-200';
      $('#panel-proyectos').classList.remove('hidden');
      $('#panel-miembros').classList.add('hidden');
    });

    // ------------------ Carga Resumen ------------------
    async function cargarResumen() {
      try {
        const r = await fetch('/reportes/informacion');
        const j = await r.json();
        $('#card-proyectos').textContent = j.total_proyectos ?? '0';
        $('#card-en-progreso').textContent = j.en_progreso ?? '0';
        $('#card-done').textContent = j.done ?? '0';
        $('#card-miembros').textContent = j.miembros_totales ?? '0';
      } catch (e) { console.error(e); }
    }

    // ------------------ Miembros ------------------
    async function listarMiembros() {
      const r = await fetch('/miembros');
      const data = await r.json();
      const tbody = $('#tbody-miembros');
      tbody.innerHTML = '';
      data.forEach(m => {
        const tr = document.createElement('tr');
        tr.className = 'border-b';
        tr.innerHTML = `
          <td class="py-2 pr-3">${m.id}</td>
          <td class="py-2 pr-3">${m.nombre}</td>
          <td class="py-2 pr-3">${m.rol ?? ''}</td>
          <td class="py-2 pr-3">${m.email}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    $('#btn-refrescar-miembros').addEventListener('click', async () => {
      await listarMiembros(); await cargarResumen(); showToast('Miembros actualizados');
    });

    $('#form-miembro').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const f = ev.target;
      const payload = {
        nombre: f.nombre.value.trim(),
        rol: f.rol.value.trim() || null,
        email: f.email.value.trim(),
      };
      $('#msg-miembro').classList.add('hidden');
      try {
        const r = await fetch('/miembros', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        if (!r.ok) {
          const err = await r.json().catch(()=>({detail:'Error'}));
          throw new Error(err?.detail || 'No se pudo crear el miembro');
        }
        f.reset();
        await listarMiembros();
        await cargarResumen();
        showToast('Miembro creado correctamente');
      } catch (e) {
        $('#msg-miembro').textContent = e.message;
        $('#msg-miembro').classList.remove('hidden');
        showToast(e.message, false);
      }
    });

    // ------------------ Proyectos ------------------
    async function listarProyectos() {
      const r = await fetch('/proyectos');
      const data = await r.json();
      const tbody = $('#tbody-proyectos');
      tbody.innerHTML = '';
      data.forEach(p => {
        const tr = document.createElement('tr');
        tr.className = 'border-b';
        tr.innerHTML = `
          <td class="py-2 pr-3">${p.id}</td>
          <td class="py-2 pr-3">${p.nombre}</td>
          <td class="py-2 pr-3">${p.estado}</td>
          <td class="py-2 pr-3">${fmt(p.start_date)}</td>
          <td class="py-2 pr-3">${fmt(p.end_date)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    $('#btn-refrescar-proyectos').addEventListener('click', async () => {
      await listarProyectos(); await cargarResumen(); showToast('Proyectos actualizados');
    });

    $('#form-proyecto').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const f = ev.target;
      const payload = {
        nombre: f.nombre.value.trim(),
        descripcion: f.descripcion.value.trim() || null,
        estado: f.estado.value,
        start_date: f.start_date.value || null,
        end_date: f.end_date.value || null,
      };
      $('#msg-proyecto').classList.add('hidden');
      try {
        const r = await fetch('/proyectos', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        if (!r.ok) {
          const err = await r.json().catch(()=>({detail:'Error'}));
          throw new Error(err?.detail || 'No se pudo crear el proyecto');
        }
        f.reset();
        await listarProyectos();
        await cargarResumen();
        showToast('Proyecto creado correctamente');
      } catch (e) {
        $('#msg-proyecto').textContent = e.message;
        $('#msg-proyecto').classList.remove('hidden');
        showToast(e.message, false);
      }
    });

    // ------------------ Init ------------------
    (async function init(){
      await Promise.all([cargarResumen(), listarMiembros(), listarProyectos()]);
    })();
  </script>
</body>
</html>
